//backup abyss diva, because it will throw an error if enable it
/*
pixi-spine.js:4717 Uncaught Error: Invalid timeline type for a bone: flipX (yu3)
"bust_11006_superKanban": {
    "0": {
      "path": "effect/dating/ui_superKanban_11006/meirenyubeijing",
      "action": "animation"
    }
  },

//natsumi lucky queen .skel file, idk
  "bust_11308_superKanban": {
    "0": {
      "path": "effect/dating/ui_superKanban_11308/effect_main_11308",
      "action": "animation"
    }
  },
*/

/*
to do :
10511 layering
*/

let charaEffect = {
  "bust_10109_superKanban": {
  	"0": {
  	  "path":"effect/dating/ui_superKanban_10109/effect_main_10109_1",
  	  "action":"stand"
  	},
    "1": {
      "path": "effect/dating/ui_superKanban_10109/effect_main_10109_2",
      "action": "stand"
    },
    "2": {
      "path": "effect/dating/ui_superKanban_10109/effect_main_10109_3",
      "action": "stand"
    }
  },
  "bust_10111_superKanban": {
  	"0": {
  	  "path":"effect/dating/ui_superKanban_10111/effect_main_10111",
  	  "action":"animation"
  	}
  },
  "bust_10113_superKanban": {
  	"0": {
      "path": "effect/dating/ui_superKanban_10113/effect_shixiangkanbanBG",
      "action": "animation"
    },
    "1": {
      "path": "effect/dating/ui_superKanban_10113/effect_shixiangkanban",
      "action": "animation"
    },
    "2": {
    	"path": "effect/dating/ui_superKanban_10113/effect_shixiangkanban",
    	"action": "animation2"
    }
  },
  "bust_10116_superKanban": {
    "0": {
      "path": "effect/dating/ui_superKanban_10116/effect_main_10116",
      "action": "playbelow"
    },
    "1": {
  		"path":"effect/dating/ui_superKanban_10116/effect_main_10116",
  		"action":"playup"
  	}
  },
  "bust_10119_superKanban": {
    "0": {
      "path": "effect/dating/ui_superKanban_10119/hanfushixiangjangkanban",
      "action": "animation"
    }
  },
  "bust_10213_superKanban": {
    "0": {
      "path": "effect/dating/ui_superKanban_10213/effect_main_10213",
      "action": "animation_down"
    },
    "1": {
    	"path": "effect/dating/ui_superKanban_10213/effect_main_10213",
    	"action":"animation_up"
    }
  },
  "bust_10216_superKanban": {
    "0": {
      "path": "effect/dating/ui_superKanban_10216/effect_main_10216",
      "action": "effect_main_10216_dpwn"
    },
    "1": {
      "path": "effect/dating/ui_superKanban_10216/effect_main_10216",
      "action": "effect_main_10216_liuxing"
    },
    "2": {
    	"path":"effect/dating/ui_superKanban_10216/effect_main_10216",
    	"action":"effect_main_10216_up"
    }
  },
  "bust_10219_superKanban": {
  	"0": {
  		"path":"effect/dating/ui_superKanban_10219/effect_main_10219",
  		"action":"animation"
  	}
  },
  "bust_10307_superKanban": {
    "0": {
      "path": "effect/dating/ui_superKanban_10307/bg_ssn_high1",
      "action": "animation"
    }
  },
  "bust_10309_superKanban": {
    "0": {
      "path": "effect/dating/ui_superKanban_10309/effect_hefusisinai",
      "action": "effect_hefusisinai_xia"
    },
    "1": {
    	"path":"effect/dating/ui_superKanban_10309/effect_hefusisinai",
    	"action":"effect_hefusisinai_shang"
    }
  },
  "bust_10409_superkanban": {
    "0": {
      "path": "effect/dating/ui_superKanban_10409/effect_main_10409",
      "action": "animation"
    }
  },
  "bust_10414_superkanban": {
    "0": {
      "path": "effect/dating/ui_superKanban_10414/effect_main_10414",
      "action": "play"
    }
  },
  "bust_10416_superkanban": {
    "0": {
      "path": "effect/dating/ui_superKanban_10416/effects_hfkuangsankanban",
      "action": "effects_hfkuangsankanban_all"
    }
  },
  "bust_10507_new": {
  	"0": {
  		"path": "effect/dating/ui_superKanban_10507/effect_main_10507",
  		"action":"animation"
  	}
  },
  "bust_10509_superKanban": {
    "0": {
      "path": "effect/dating/ui_superKanban_10509/effect_main_10509",
      "action": "animation"
    }
  },
  "bust_10511_superKanban": {
    "0": {
      "path": "effect/dating/ui_superKanban_10511/effect_main_10511",
      "action": "lizi_up"
    },
    "1": {
      "path": "effect/dating/ui_superKanban_10511/effect_main_10511",
      "action": "up"
    },
    "2": {
      "path": "effect/dating/ui_superKanban_10511/effect_main_10511",
      "action": "lizi_down"
    },
    "3": {
      "path": "effect/dating/ui_superKanban_10511/effect_main_10511",
      "action": "down"
    }
  },
  "bust_11006_superKanban": {
  	"0": {
  		"path":"effect/dating/ui_superKanban_11006/paopao4",
  		"action":"4"
  	},
  	"1": {
  		"path":"effect/dating/ui_superKanban_11006/paopao3",
  		"action":"3"
  	},
  	"2": {
  		"path":"effect/dating/ui_superKanban_11006/paopao2",
  		"action":"2"
  	},
  	"3": {
  		"path":"effect/dating/ui_superKanban_11006/paopao1",
  		"action":"1"
  	}
  },
  "bust_11207_superKanban": {
    "0": {
      "path": "effect/dating/ui_superKanban_11207/effect_main_11207",
      "action": "animation"
    }
  },
  "bust_11209_superKanban": {
    "0": {
      "path": "effect/dating/ui_superKanban_11209/effect_main_11209",
      "action": "animation2"
    }
  },
  "bust_11311_superKanban": {
    "0": {
      "path": "effect/dating/ui_superKanban_11311/effect_main_11313",
      "action": "animation"
    }
  },
  "bust_11502_superKanban": {
    "0": {
      "path": "effect/dating/ui_superKanban_11502/skeleton",
      "action": "animation"
    }
  }
};


var bgEffect = {
	list : {},
	isLoaded : false,

	backgroundManager : function(model, l2dViewer) {
		bgEffect.list = {};
		bgEffect.isLoaded = false;
		if(charaEffect[model]) {
			console.log('bgeffect exists, ' + model)
			var tempArr = [];
			for(var i in charaEffect[model]) {
				tempArr.push('assets/res/basic/' + charaEffect[model][i]['path'] + '.json:' + charaEffect[model][i]['action'])
			}
			bgEffect.backgroundEffect.add(tempArr, l2dViewer);
		} else {
			bgEffect.isLoaded = true;
		}
	},

	backgroundEffect : {
		add : function(data, l2dViewer) {
			let loader = new PIXI.Loader();
			for(var i=0;i<data.length;i++) {
				loader.add('bgEffect' + i, data[i].split(':')[0]);
			}
			loader.load((loader, res) => {
				for(var i=0;i<data.length;i++) {
					const s = new PIXI.spine.Spine(res['bgEffect' + i].spineData);
					//to do idk how to automaticly set based resolution, so i'll set this for by screen reso / 2
					s.scale.x = s.scale.y = 1;
					s.x = window.innerWidth / 2;
					s.y = window.innerHeight / 2;

					s.state.setAnimation(0, data[i].split(':')[1], true);
					l2dViewer.app.stage.addChild(s);
					bgEffect.list['bgEffect' + i] = {}
					bgEffect.list['bgEffect' + i].x = s.x;
					bgEffect.list['bgEffect' + i].y = s.y;
					bgEffect.list['bgEffect' + i].scale = s.scale.x;
				}
				bgEffect.addSetting(l2dViewer);
				loader.reset();		
			});
		}
	},

	addSetting : function(l2dViewer) {
		document.getElementById('bg-effect').innerHTML = '';
		var n = 0; //Spine index to do
		//spine finder
		for(;n<l2dViewer.app.stage.children.length;n++) {
			if(l2dViewer.app.stage.children[n].constructor.name == "Spine") {
				break;
				
			}
		}
		for(var i in bgEffect.list) {
			let div = document.createElement('div');
			div.classList.add('l2dv3-collapsible');

			let x = document.createElement('input');
			x.type = 'number';
			x.min = 0;
			x.value = bgEffect.list[i].x;
			x.id = i + 'x';
			x.name = i + 'x';

			let y = document.createElement('input');
			y.type = 'number';
			y.min = 0;
			y.value = bgEffect.list[i].y;
			y.id = i + 'y';
			y.name = i + 'y';

			let scale = document.createElement('input');
			scale.type = 'number';
			scale.min = 50;
			scale.value = bgEffect.list[i].scale * 100;
			scale.id = i + 'scale';
			scale.name = i + 'scale';

			//label
			let label1 = document.createElement('label');
			label1.for = x.name
			label1.innerHTML = 'X';
			let label2 = document.createElement('label');
			label2.for = y.name
			label2.innerHTML = 'Y';
			let label3 = document.createElement('label');
			label3.for = scale.name
			label3.innerHTML = 'Scale';

			//to do customization effect
			x.setAttribute('index', n);
			y.setAttribute('index', n);
			scale.setAttribute('index', n);
			x.onchange = function() { bgEffect.changePosX(this.getAttribute('index'), this.value, l2dViewer) };
			y.onchange = function() { bgEffect.changePosY(this.getAttribute('index'), this.value, l2dViewer) };
			scale.onchange = function() { bgEffect.changeScale(this.getAttribute('index'), this.value, l2dViewer) };

			//t
			let t = document.createElement('div');
			let t1 = document.createElement('div');
			let t2 = document.createElement('div');
			let mainButton = document.createElement('button');
			mainButton.classList.add('l2dv3-collapsible-main');
			mainButton.classList.add('customButton');
			mainButton.innerHTML = i;

			t.appendChild(x);
			t1.appendChild(y);
			t2.appendChild(scale);

			div.appendChild(label1);

			div.appendChild(t);
			div.appendChild(label2);

			div.appendChild(t1);
			div.appendChild(label3);

			div.appendChild(t2);
			document.getElementById('bg-effect').appendChild(mainButton)
			document.getElementById('bg-effect').appendChild(div);
			n++;
		}
		bgEffect.isLoaded = true;
		let cc = document.getElementsByClassName('l2dv3-collapsible-main');
		for(var i=0;i<cc.length;i++) {
		cc[i].addEventListener("click", function() {
			let content = this.nextElementSibling;
			if(content.style.lineHeight != 0) {
				//content.style.display = 'none';
				content.style.lineHeight = 0;
				content.style.height = 0;
			} else {
				//content.style.display = 'block';
				content.style.lineHeight = 'normal';
				content.style.height = '150px';
			}
		})
		}
		
	},

	changePosX : function(index, value, l2dViewer) {
		l2dViewer.app.stage.children[index].x = value;
	},
	changePosY : function(index, value, l2dViewer) {
		l2dViewer.app.stage.children[index].y = value;
	},
	changeScale : function(index, value, l2dViewer) {
		l2dViewer.app.stage.children[index].scale.x = value / 100;
		l2dViewer.app.stage.children[index].scale.y = value / 100;
	},
};

